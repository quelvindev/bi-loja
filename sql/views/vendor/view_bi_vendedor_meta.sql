
CREATE OR REPLACE VIEW view_bi_vendedor_meta AS 
SELECT
    PCDATAS.DATA,
    PCMETA.CODFILIAL COD_FILIAL,
    PCMETA.CODUSUR COD_RCA,
    DECODE(PCDATAS.DATA,TRUNC(PCDATAS.DATA,'MM'),PCMETA.VLVENDAPREV,0) VLR_META ,
    TRUNC((CASE WHEN PCDATAS.DIAUTIL = 'S' THEN NVL(PCMETA.VLVENDAPREV,0)/DUTIL.D ELSE 0 END),2)VLR_META_DIA,
    TO_CHAR(PCDATAS.DATA,'MM') MES,
    TO_CHAR(PCDATAS.DATA,'YYYY') ANO
    
FROM  
    PCDATAS 
        LEFT JOIN PCMETA
        ON EXTRACT(MONTH FROM PCMETA.DATA) =  EXTRACT(MONTH FROM PCDATAS.DATA)
    AND EXTRACT(YEAR FROM PCMETA.DATA) = EXTRACT(YEAR FROM PCDATAS.DATA),
        
        (  SELECT    
        SUM(DECODE(D.DIAUTIL,'S',1,0))D, 
        EXTRACT(MONTH FROM D.DATA)MES,
        EXTRACT(YEAR FROM D.DATA)ANO 
    FROM 
        PCDATAS D 
    GROUP BY 
        EXTRACT(MONTH FROM D.DATA),
        EXTRACT(YEAR FROM D.DATA) ) DUTIL 
        
WHERE 
    PCMETA.VLVENDAPREV > 0
    AND DUTIL.MES = EXTRACT(MONTH FROM PCDATAS.DATA)
    AND DUTIL.ANO = EXTRACT(YEAR FROM PCDATAS.DATA)
    AND PCDATAS.DATA BETWEEN ADD_MONTHS( TRUNC(SYSDATE,'YY'),-12) AND TRUNC(SYSDATE)

ORDER BY DATA,COD_FILIAL, COD_RCA
 WITH READ ONLY  